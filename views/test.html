<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>ByteMe Chat App</title>
<style>
body { font-family: sans-serif; background: #f0f0f0; display: flex; justify-content: center; padding-top: 40px; }
.container { background: white; padding: 20px; border-radius: 10px; width: 400px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
.hidden { display: none; }
#chatWindow { border: 1px solid #ccc; height: 250px; overflow-y: auto; padding: 10px; background: #fafafa; margin-bottom: 10px; }
.message { margin-bottom: 10px; }
.me { text-align: right; color: blue; }
.other { color: black; }
input, button { margin: 5px 0; width: 100%; padding: 8px; }
#status { font-size: 0.9em; color: gray; margin-bottom: 10px; text-align: center; position: relative; }
#spinner {
    width: 16px;
    height: 16px;
    border: 2px solid orange;
    border-top: 2px solid transparent;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    display: inline-block;
    vertical-align: middle;
    margin-right: 8px;
}
#connectionStatus {
    position: absolute;
    top: -20px;
    right: 10px;
    font-size: 0.8em;
}
#connectionStatus.connected { color: green; }
#connectionStatus.disconnected { color: red; }
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
.error { color: red; }
</style>
</head>
<body>

<div class="container">
<h2>ByteMe Chat</h2>

<!-- Status Indicator -->
<div id="status">
    <span id="connectionStatus">Disconnected</span>
</div>

<!-- Login Form -->
<div id="loginForm">
    <input type="email" id="email" placeholder="Email" />
    <input type="password" id="password" placeholder="Password" />
    <button onclick="handleLogin()">Login</button>
</div>

<!-- Chat area -->
<div id="chatArea" class="hidden">
    <div><strong>Game ID:</strong> <span id="activeGameId">1</span></div>
    <div id="chatWindow"></div>
    <input id="messageInput" placeholder="Type your message..." />
    <button onclick="sendMessage()">Send</button>
    <button onclick="logout()">Logout</button>
</div>
</div>

<script>
const currentGameId = 1;
const chatUrl = "https://iu-tomcat.servicecluster.de/byteme/api/game/chat";

function handleLogin() {
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;

    fetch("https://iu-tomcat.servicecluster.de/byteme/api/login", {
    method: "POST",
    headers: { "Content-Type": "application/json" }, //credentials: "include",
    body: JSON.stringify({ email, password })
    })
    .then(response => {
    if (!response.ok) throw new Error("Login failed");
    document.getElementById("loginForm").classList.add("hidden");
    document.getElementById("chatArea").classList.remove("hidden");
    updateStatus("Login successful");
    updateConnectionStatus(true);
    fetchMessages();
    setInterval(fetchMessages, 3000);
    })
    .catch(error => {
    updateStatus("Login failed: " + error.message, "error");
    updateConnectionStatus(false);
    });
}

async function sendMessage() {
    const text = document.getElementById('messageInput').value;
    if (!text) return;

    updateStatus("Sending message...", "loading");

    try {
    const res = await fetch(chatUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" }, //credentials: "include",
        body: JSON.stringify({ gameId: currentGameId, text })
    });

    if (!res.ok) throw new Error("Server error while sending message");

    document.getElementById('messageInput').value = '';
    updateStatus("Message sent");
    fetchMessages();
    updateConnectionStatus(true);
    } catch (e) {
    updateStatus("Send message failed: " + e.message, "error");
    updateConnectionStatus(false);
    console.error("Send message failed", e);
    }
}

async function fetchMessages() {
    updateStatus("Loading messages...", "loading");

    try {
    const res = await fetch(`${chatUrl}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" }, //credentials: "include",
        body: JSON.stringify({ gameId: currentGameId })
    });

    if (!res.ok) throw new Error("Failed to fetch messages");

    const data = await res.json();
    updateChatWindow(data);
    updateStatus("Messages updated");
    updateConnectionStatus(true);
    } catch (e) {
    updateStatus("Fetch failed: " + e.message, "error");
    updateConnectionStatus(false);
    console.error("Fetch messages failed", e);
    }
}

function appendMessage(msg) {
    const chatWindow = document.getElementById("chatWindow");
    const div = document.createElement("div");
    const isMe = !msg.author || !msg.author.id || msg.author.email === "test@test.com";
    div.className = "message " + (isMe ? "me" : "other");
    const label = isMe ? "You" : (msg.author.name || msg.author.email || "User");
    div.innerText = `${label}: ${msg.message}`;
    chatWindow.appendChild(div);
    chatWindow.scrollTop = chatWindow.scrollHeight;
}

function updateChatWindow(messages) {
    const chatWindow = document.getElementById("chatWindow");
    chatWindow.innerHTML = "";
    messages.forEach(appendMessage);
}

function updateStatus(message, type = "") {
    const statusEl = document.getElementById("status");
    statusEl.className = type;
    const connectionEl = document.getElementById("connectionStatus");
    if (type === "loading") {
    statusEl.innerHTML = `<span id='spinner'></span>${message}<span id="connectionStatus" class="${connectionEl.className}">${connectionEl.textContent}</span>`;
    } else {
    statusEl.innerHTML = `${message}<span id="connectionStatus" class="${connectionEl.className}">${connectionEl.textContent}</span>`;
    }
}

function updateConnectionStatus(isConnected) {
    const connectionEl = document.getElementById("connectionStatus");
    if (isConnected) {
    connectionEl.textContent = "Connected";
    connectionEl.className = "connected";
    } else {
    connectionEl.textContent = "Disconnected";
    connectionEl.className = "disconnected";
    }
}

function logout() {
    fetch("https://iu-tomcat.servicecluster.de/byteme/logout", {
    method: "POST",
    //credentials: "include"
    }).finally(() => {
    location.href = "login.html";
    });
}
</script>

</body>
</html>
